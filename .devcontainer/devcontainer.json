{
  "name": "Lace Development (Worktrees)",
  // NOTE: docs/worktree_development.md for details.
  "build": {
    "dockerfile": "Dockerfile",
    "args": {
      "TZ": "${localEnv:TZ:America/Los_Angeles}",
      // NOTE: Tied to project/bash-history declaration below
      "COMMAND_HISTORY_PATH": "/commandhistory",
      // NOTE: Tied to project/claude-config declaration below
      "USERNAME": "node"
    },
    "context": ".."
  },
  "runArgs": [],
  "customizations": {
    "lace": {
      // Workspace layout: auto-detect bare-repo worktree and generate
      // workspaceMount/workspaceFolder/postCreateCommand (safe.directory).
      // Without lace, set these manually (see comments at bottom of file).
      "workspace": {
        "layout": "bare-worktree",
        "mountTarget": "/workspace/lace"
      },
      // Mount declarations: lace resolves host source paths from settings or defaults.
      // project/bash-history and project/claude-config are auto-injected into the
      // mounts array during lace up. Configure custom source paths in settings.json:
      //   { "mounts": { "project/claude-config": { "source": "~/.claude" } } }
      "mounts": {
        "bash-history": {
          "target": "/commandhistory",
          "description": "Bash command history persistence"
        },
        "claude-config": {
          "target": "/home/node/.claude",
          "recommendedSource": "~/.claude",
          "description": "Claude Code configuration and credentials"
        }
      },
      "prebuildFeatures": {
        "ghcr.io/devcontainers/features/git:1": {},
        "ghcr.io/devcontainers/features/sshd:1": {},
        "ghcr.io/anthropics/devcontainer-features/claude-code:1": {},
        "ghcr.io/devcontainers-extra/features/neovim-homebrew:1": {},
        "ghcr.io/eitsupi/devcontainer-features/nushell:0": {},
        "ghcr.io/weftwiseink/devcontainer-features/wezterm-server:1": {
          "version": "20240203-110809-5046fc22"
        }
      }
    }
  },
  "mounts": [
    // Container-side wezterm config for mux server (sets default_cwd)
    // Bind mount instead of Dockerfile COPY so changes take effect without rebuild
    "source=${localWorkspaceFolder}/.devcontainer/wezterm.lua,target=/home/node/.config/wezterm/wezterm.lua,type=bind,readonly"
    // wezterm-server/authorized-keys, project/bash-history, and project/claude-config
    // are auto-injected from feature metadata and customizations.lace.mounts declarations
  ],
  "containerEnv": {
    "NODE_OPTIONS": "--max-old-space-size=4096",
    "CLAUDE_CONFIG_DIR": "${lace.mount(project/claude-config).target}"
  },
  // workspaceMount, workspaceFolder, and postCreateCommand (safe.directory) are
  // auto-generated by customizations.lace.workspace above during `lace up`.
  // For contributors without lace, uncomment these lines:
  // "workspaceMount": "source=${localWorkspaceFolder}/..,target=/workspace,type=bind,consistency=delegated",
  // "workspaceFolder": "/workspace/main",
  // "postCreateCommand": "git config --global --add safe.directory '*'",
  // Start wezterm mux daemon for SSH domain multiplexing (sshd is started by the sshd feature)
  "postStartCommand": "wezterm-mux-server --daemonize 2>/dev/null || true"
}
