#!/bin/bash
# Connect to a lace devcontainer via WezTerm using Docker discovery.
#
# Usage:
#   wez-lace-into             # Interactive picker (fzf or bash select)
#   wez-lace-into <project>   # Connect directly to named project
#   wez-lace-into --list      # List running project names
#   wez-lace-into --status    # Show projects with ports and paths
#
# This script discovers running lace devcontainers via Docker and
# connects to them using WezTerm's SSH domains (lace:PORT).
#
# Prerequisites:
#   - wezterm installed
#   - Docker running with devcontainers
#   - Devcontainer started with `lace up` (port in 22425-22499 range)
#   - WezTerm config includes lace plugin with SSH domains registered

set -euo pipefail

SCRIPT_NAME="$(basename "$0")"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Use lace-discover for project discovery
LACE_DISCOVER="${SCRIPT_DIR}/lace-discover"

# --- Helper functions ---
err() {
  echo "${SCRIPT_NAME}: error: $*" >&2
}

info() {
  echo "${SCRIPT_NAME}: $*" >&2
}

# --- Check prerequisites ---
if ! command -v wezterm &>/dev/null; then
  err "wezterm not found on PATH"
  err "Install from: https://wezfurlong.org/wezterm/installation.html"
  exit 1
fi

if [[ ! -x "$LACE_DISCOVER" ]]; then
  err "lace-discover not found at $LACE_DISCOVER"
  exit 1
fi

# --- Discover projects ---
discover_projects() {
  "$LACE_DISCOVER"
}

# --- Parse arguments ---
case "${1:-}" in
  --list)
    discover_projects | cut -d: -f1
    ;;

  --status)
    discover_projects | while IFS=: read -r name port user path; do
      echo "[*] $name (:$port) - $path"
    done
    ;;

  -h|--help)
    head -18 "${BASH_SOURCE[0]}" | tail -n +2 | sed 's/^# \?//'
    exit 0
    ;;

  "")
    # Interactive picker
    mapfile -t PROJECTS < <(discover_projects)

    if [[ ${#PROJECTS[@]} -eq 0 ]]; then
      err "No running devcontainers found"
      err "Start a devcontainer with: lace up"
      exit 1
    fi

    if [[ ${#PROJECTS[@]} -eq 1 ]]; then
      # Only one project, connect directly
      IFS=: read -r PROJECT PORT USER PATH_VAL <<< "${PROJECTS[0]}"
      info "Connecting to $PROJECT on port $PORT..."
      exec wezterm connect "lace:$PORT" --workspace "$PROJECT"
    fi

    # Multiple projects - show picker
    if command -v fzf &>/dev/null; then
      SELECTED=$(printf '%s\n' "${PROJECTS[@]}" | \
        awk -F: '{print $1 " (:" $2 ") - " $4}' | \
        fzf --prompt="Select project: " --height=10 --reverse)
      if [[ -z "$SELECTED" ]]; then
        exit 0
      fi
      PROJECT=$(echo "$SELECTED" | cut -d' ' -f1)
    else
      # Fallback to bash select
      PS3="Select project: "
      mapfile -t NAMES < <(printf '%s\n' "${PROJECTS[@]}" | cut -d: -f1)
      select PROJECT in "${NAMES[@]}"; do
        [[ -n "$PROJECT" ]] && break
      done
    fi

    # Find port for selected project
    for proj in "${PROJECTS[@]}"; do
      if [[ "${proj%%:*}" == "$PROJECT" ]]; then
        IFS=: read -r _ PORT _ _ <<< "$proj"
        break
      fi
    done

    info "Connecting to $PROJECT on port $PORT..."
    exec wezterm connect "lace:$PORT" --workspace "$PROJECT"
    ;;

  *)
    # Direct project name - find its port
    PROJECT="$1"
    PORT=""

    while IFS=: read -r name port user path; do
      if [[ "$name" == "$PROJECT" ]]; then
        PORT="$port"
        break
      fi
    done < <(discover_projects)

    if [[ -z "$PORT" ]]; then
      err "Project '$PROJECT' not found"
      err ""
      err "Running projects:"
      discover_projects | cut -d: -f1 | sed 's/^/  /' >&2
      exit 1
    fi

    info "Connecting to $PROJECT on port $PORT..."
    exec wezterm connect "lace:$PORT" --workspace "$PROJECT"
    ;;
esac
