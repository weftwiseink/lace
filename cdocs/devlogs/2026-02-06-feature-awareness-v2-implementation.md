---
first_authored:
  by: "@claude-opus-4-6"
  at: 2026-02-06T13:45:00-08:00
type: devlog
state: archived
status: done
tags: [features, ports, templating, refactor]
implements: cdocs/proposals/2026-02-06-lace-feature-awareness-v2.md
last_reviewed:
  status: accepted
  by: "@claude-opus-4-6"
  at: 2026-02-06T14:10:00-08:00
  round: 1
---

# Devlog: Feature Awareness v2 Implementation

## Overview

Implementing the feature awareness v2 proposal which replaces lace's hardcoded
wezterm port assignment with a metadata-driven port system. Features declare port
options in `customizations.lace.ports`; lace auto-injects `${lace.port()}`
template expressions and resolves them to concrete port numbers.

Builds on the existing feature-metadata.ts module (commits 570df53, dedf382,
ec35e2f) which provides OCI manifest fetching, two-tier caching, validation,
and `extractLaceCustomizations()`.

## Phase 1: Template resolver + port allocator

**Status:** done
**Commit:** 3a52db6

### Plan

1. Create `port-allocator.ts` -- label-based port allocation with persistence
2. Create `template-resolver.ts` -- auto-injection + template resolution + port entry generation
3. Update `up.ts` -- replace hardcoded port assignment with the new pipeline
4. Update integration tests
5. Maintain backwards compatibility with existing port-manager.ts during transition

### What was built

#### `port-allocator.ts`
- `PortAllocator` class: label-based allocation in range 22425-22499
- Persistence in `.lace/port-assignments.json`
- Stable reuse: if a label already has a port and it is available, reuse it
- Reassignment: if the saved port is occupied, find a new one
- Types: `PortAllocation`, `PortAssignmentsFile`, `PortAttributes`, `AutoGeneratedPortEntries`, `FeaturePortDeclaration`
- 10 unit tests covering fresh allocation, stable reuse, reassignment, multi-label, persistence, corrupt file handling

#### `template-resolver.ts`
- `extractFeatureShortId()`: extracts short ID from OCI feature references
- `buildFeatureIdMap()`: maps short IDs to full feature IDs (detects collisions)
- `autoInjectPortTemplates()`: reads feature metadata, injects `${lace.port(shortId/optionName)}` for port options the user hasn't set
- `resolveTemplates()`: walks config tree, resolves `${lace.port(...)}` to concrete port numbers via PortAllocator. Integer coercion when template is the entire value, string interpolation when embedded.
- `generatePortEntries()`: builds `appPort`, `forwardPorts`, `portsAttributes` from allocations. Detects user suppression (explicit `appPort`/`forwardPorts`/`portsAttributes` in source config).
- `mergePortEntries()`: merges auto-generated entries into config
- `buildFeaturePortMetadata()`: extracts label/requireLocalPort from feature metadata for portsAttributes enrichment
- `warnPrebuildPortTemplates()`: warns if `${lace.port()}` appears in prebuildFeatures options
- 46 unit tests covering all functions and edge cases

#### `up.ts` pipeline rewrite
- Removed hardcoded `assignPort()` call and `port-manager` import
- New pipeline: fetch metadata -> auto-inject port templates -> resolve templates -> generate port entries -> merge into extended config
- Added `templateResolution` phase to `UpResult`
- Updated `generateExtendedConfig()` to accept resolved config + allocations + feature port metadata

#### Integration tests
- Updated existing "no repo mounts or prebuild" test to expect new behavior (no port allocation when no features)
- 6 new integration tests: auto-inject from metadata, user static override, explicit template, asymmetric appPort suppression, no-lace-port-metadata passthrough, skip-validation fallback

### Test results
- 425 tests passing across 19 test files

## Phase 2: Feature metadata management

**Status:** done (prior work)
**Commits:** 570df53, dedf382, ec35e2f

Already implemented before this workstream. Provides:
- OCI manifest + blob fetching via `skopeo`
- Two-tier cache (in-memory + filesystem with TTL)
- `extractLaceCustomizations()` for reading `customizations.lace.ports`
- `validateFeatureOptions()` and `validatePortDeclarations()`
- Integration into `lace up` pipeline

## Phase 3: Migration and cleanup

**Status:** done
**Commit:** 96b6558

### Changes
- Moved `isPortAvailable`, `LACE_PORT_MIN`, `LACE_PORT_MAX` from `port-manager.ts` into `port-allocator.ts`
- Deleted `port-manager.ts` and `port-manager.test.ts`
- Updated `port-allocator.test.ts` imports
- All port functionality now served by port-allocator + template-resolver pipeline

### Test results
- 408 tests passing across 18 test files (17 port-manager tests removed with module)
- TypeScript type check passes cleanly

## Summary

All three phases complete. The lace codebase now has a fully metadata-driven port system:
1. Features declare port options in `customizations.lace.ports` in their `devcontainer-feature.json`
2. Lace auto-injects `${lace.port(featureId/optionName)}` templates for declared port options
3. Templates resolve to concrete port numbers via label-based allocation
4. Ports are persisted for stability across restarts
5. `appPort`, `forwardPorts`, `portsAttributes` are auto-generated with suppression detection
6. The old hardcoded wezterm port assignment is fully removed
