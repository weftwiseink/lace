---
first_authored:
  by: "@claude-opus-4-5-20251101"
  at: 2026-01-31T22:00:00-08:00
task_list: lace/devcontainer-features
type: devlog
state: archived
status: completed
tags: [devcontainer-features, wezterm, implementation, phase-1a, phase-2]
last_reviewed:
  status: accepted
  by: "@claude-opus-4-5-20251101"
  at: 2026-01-31T23:55:00-08:00
  round: 2
---

# Scaffold devcontainer features with Wezterm Server: Devlog

## Objective

Implement the accepted proposal `cdocs/proposals/2026-01-30-scaffold-devcontainer-features-wezterm-server.md`.

Create the `devcontainers/features/` directory structure with a wezterm-server devcontainer feature that extracts wezterm binaries from `.deb` packages for headless use. Set up CI/CD workflows for testing and publishing to GHCR.

Scope for this session: Phase 1a (Debian-only feature) and Phase 2 (CI/CD workflows). Phase 0 (GHCR prerequisites) is a human task (org settings). Phase 1b (cross-platform) and Phase 3 (Dockerfile migration) are deferred per the proposal.

## Plan

1. Create directory scaffold (`devcontainers/features/src/wezterm-server/`, `devcontainers/features/test/wezterm-server/`)
2. Write `devcontainer-feature.json` with options schema
3. Write `install.sh` (Debian-only with distro detection scaffolding)
4. Write `test.sh` and `scenarios.json` for Phase 1a scenarios
5. Create CI/CD workflows (test + release)
6. Run shellcheck on install.sh
7. Commit each logical unit

## Testing Approach

- `shellcheck install.sh` for POSIX compliance
- JSON validation of `devcontainer-feature.json`
- Local `devcontainer features test` if Docker is available (requires human to run)
- CI workflow will run scenario-based tests on PR

## Implementation Notes

- `install.sh` is a direct lift of the proven `.deb` extraction logic from the existing Dockerfile (lines 97-110), adapted to POSIX sh with distro detection scaffolding for future Phase 1b cross-platform support.
- Distro detection uses `/etc/os-release` sourcing with `ID` and `ID_LIKE` fallback. Non-Debian distros get a clear error message rather than a silent failure.
- Architecture detection uses `uname -m` (portable) instead of `dpkg --print-architecture` (Debian-only), per proposal guidance.
- The `no_runtime_dir` test scenario uses bare `debian:bookworm` (no devcontainer base image) to test the feature on a minimal image without `createRuntimeDir`.
- CI/CD workflows use `paths:` triggers scoped to `devcontainers/features/**` to avoid running on unrelated repo changes.
- Release workflow uses `features-namespace: "weftwiseink/devcontainer-features"` to publish under the preferred OCI namespace rather than the default `weftwiseink/lace/*`.

### Local testing discovered missing scenario scripts

First test run revealed the `devcontainer features test` framework requires a script per scenario in `scenarios.json`. The default `test.sh` only runs for `--base-image` invocations. Added `debian_default.sh`, `ubuntu_default.sh`, `custom_version.sh` (copies of `test.sh`).

### CI runtime dir check failure

CI tests failed because `install.sh` creates `/run/user/<_REMOTE_USER_UID>` (1000 for `vscode`) but test containers run as root (UID 0). The check `test -d /run/user/$(id -u)` returned `/run/user/0` which doesn't exist. Fixed by checking for any `/run/user/<numeric>` directory with `ls -d /run/user/[0-9]*`.

### CI autogenerated test failure

The `devcontainer features test` CLI runs an autogenerated test with `ubuntu:focal` (default base image) before scenario tests. `ubuntu:focal` lacks curl, so install.sh fails. Fixed by adding `--skip-autogenerated` flag — scenarios define their own base images with curl available.

### Review round 1 fixes

Addressed all findings from `cdocs/reviews/2026-01-31-review-of-wezterm-server-feature-implementation.md`:

- **[blocking]** Created `no_runtime_dir.sh` scenario-specific test that asserts the runtime dir does NOT exist (shared `test.sh` would have failed for this scenario)
- Added `common-utils` feature to `no_runtime_dir` scenario so curl is available on bare `debian:bookworm`
- `detect_arch` now prints the unsupported architecture name to stderr before failing
- Test workflow now has explicit `permissions: contents: read`

## Changes Made

| File | Description |
|------|-------------|
| `devcontainers/features/src/wezterm-server/devcontainer-feature.json` | Feature metadata: options (version, createRuntimeDir), installsAfter deps |
| `devcontainers/features/src/wezterm-server/install.sh` | Debian-only installer with distro/arch detection scaffolding |
| `devcontainers/features/test/wezterm-server/test.sh` | Feature test: binary presence, version, runtime dir |
| `devcontainers/features/test/wezterm-server/debian_default.sh` | Scenario test: same as test.sh |
| `devcontainers/features/test/wezterm-server/ubuntu_default.sh` | Scenario test: same as test.sh |
| `devcontainers/features/test/wezterm-server/custom_version.sh` | Scenario test: same as test.sh |
| `devcontainers/features/test/wezterm-server/no_runtime_dir.sh` | Scenario-specific test: asserts runtime dir absent |
| `devcontainers/features/test/wezterm-server/scenarios.json` | 4 test scenarios: debian, ubuntu, custom version, no runtime dir |
| `.github/workflows/devcontainer-features-test.yaml` | CI test workflow on PR/push with path trigger |
| `.github/workflows/devcontainer-features-release.yaml` | Release workflow: publish to GHCR on merge to main |
| `cdocs/proposals/2026-01-30-scaffold-devcontainer-features-wezterm-server.md` | Status updated: `implementation_ready` -> `implementation_wip` |

## Verification

**shellcheck:**
```
shellcheck -e SC1091 install.sh  # SC1091: external source not followed (expected)
# Clean — no warnings or errors
```

**JSON validation:**
```
python3 -m json.tool devcontainer-feature.json  # valid
python3 -m json.tool scenarios.json              # valid
```

**Local container testing (all 4 scenarios pass, 16/16 assertions):**
```
devcontainer features test --features wezterm-server --skip-autogenerated

Scenario: debian_default  ✅ 4/4 passed
Scenario: ubuntu_default  ✅ 4/4 passed
Scenario: custom_version  ✅ 4/4 passed
Scenario: no_runtime_dir  ✅ 4/4 passed
```

**Phase 0 (GHCR prerequisites):**
- Repo workflow permissions confirmed `write` via `gh api /repos/weftwiseink/lace/actions/permissions/workflow`
- Org-level settings require `admin:org` scope (manual UI check if needed, but repo-level is sufficient)

**CI workflows (all green):**
- Test workflow run #21564350243: **PASSED** (all 4 scenarios green)
- Release workflow run #21564271019: **PASSED** (feature published to GHCR)

**GHCR publish verified:**
```
$ devcontainer features info tags ghcr.io/weftwiseink/devcontainer-features/wezterm-server
Published Tags: 1, 1.0, 1.0.0, latest

$ devcontainer features info verbose ghcr.io/weftwiseink/devcontainer-features/wezterm-server
Canonical: ghcr.io/weftwiseink/devcontainer-features/wezterm-server@sha256:26d48e3b...
Options: version (string), createRuntimeDir (boolean)
installsAfter: common-utils, sshd
```

**Remaining deferred work:**
- Phase 1b: Cross-platform (RPM, AppImage) — deferred until Debian path validated in production
- Phase 3: Dockerfile migration — gated on feature being published to GHCR (now unblocked)
